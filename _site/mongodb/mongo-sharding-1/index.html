<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.4.2 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Mongo Sharding 1 - shard 구성 - fkkmemi.notes</title>




<meta name="description" content="개요">




<meta name="author" content="fkkmemi">

<meta property="og:locale" content="ko">
<meta property="og:site_name" content="fkkmemi.notes">
<meta property="og:title" content="Mongo Sharding 1 - shard 구성">


  <link rel="canonical" href="http://localhost:4000/mongodb/mongo-sharding-1/">
  <meta property="og:url" content="http://localhost:4000/mongodb/mongo-sharding-1/">



  <meta property="og:description" content="개요">



  <meta name="twitter:site" content="@fkkmemi">
  <meta name="twitter:title" content="Mongo Sharding 1 - shard 구성">
  <meta name="twitter:description" content="개요">
  <meta name="twitter:url" content="http://localhost:4000/mongodb/mongo-sharding-1/">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@fkkmemi">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-02-22T00:00:00+09:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "fkkmemi",
      "url" : "http://localhost:4000",
      "sameAs" : ["https://twitter.com/fkkmemi","https://facebook.com/fkkmemi","https://www.linkedin.com/in/fkkmemi"]
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="fkkmemi.notes Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">fkkmemi.notes</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/categories/">Categories</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/tags/">Tags</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/links/">Links</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/about/">About</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="https://s.gravatar.com/avatar/fb8e318ec64f25e2bef47a26dde12270?s=80" alt="fkkmemi" itemprop="image">
      
    </div>
  

  <div class="author__content">
    <h3 class="author__name" itemprop="name">fkkmemi</h3>
    
      <p class="author__bio" itemprop="description">
        github page fixing...
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      

      

      
        <li>
          <a href="mailto:fkkmemi@gmail.com">
            <meta itemprop="email" content="fkkmemi@gmail.com" />
            <i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/https://github.com/fkkmemi" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">토글 메뉴</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">MongoDB Sharding</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/mongodb/mongo-sharding-1/" class="active">1. shard 구성</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/mongodb/mongo-sharding-2/" class="">2. config,router 구성</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/mongodb/mongo-sharding-3/" class="">3. 서버 확장</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Mongo Sharding 1 - shard 구성">
    <meta itemprop="description" content="개요">
    <meta itemprop="datePublished" content="February 22, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Mongo Sharding 1 - shard 구성
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  11 분 소요
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <h2 id="개요">개요</h2>

<p>데이터량이 증가하고 접속자 수가 많아질 때 관리자는 시스템 업그레이드를 고려한다.</p>

<p>고사양으로 전환하면서 용량을 증가시키는데 이러한 것을 <strong>scale-up</strong> 이라고 한다.</p>

<p>서비스에 맞는 철저한 계획으로 고사양 서버를 선정한 후 증설시에는 더 많은 비용이 발생할 수 있다..</p>

<p>시스템 사양을 올릴때 일반적으로 전원을 셧다운하고 해야하기 때문에 서비스의 연속성면에서도 좋지가 않다.</p>

<blockquote>
  <p>mongodb 제작사인 10gen은 이러한 방식이 20세기형(1970~2000)이라고 설명하고 있다.</p>
</blockquote>

<p>대용량 데이터를 탄력적으로 운영하기 위해서는 수평확장을 해야한다.</p>

<p>서버가 운영되다가 부하,용량이 늘어날때 서버를 N대 더 설치해서 분산해서 데이터를 쌓는 것이다.</p>

<p>반대의 경우 수평축소도 가능하기 때문에 탄력적인 비용으로 구성이 가능하다.</p>

<p>이것을 <strong>scale-out</strong> 이라고 한다.</p>

<p>KT Cloud Server를 3대 추가하여 수평확장이 되는지 검증해보도록 하겠다.</p>

<blockquote>
  <p>amazon aws ec2를 이용하고 싶지만 과금문제가 복잡해서 우선 KT로</p>
</blockquote>

<h2 id="준비">준비</h2>

<p>기본적으로 알아야할 사항은 공식 홈페이지를 확인한다.</p>

<p><a href="https://docs.mongodb.com/manual/sharding/">https://docs.mongodb.com/manual/sharding/</a></p>

<blockquote>
  <p>실제 권장하는 서버를 운영할때 필요한 물리 서버는 최소 8대지만 대규모 서버도 아니고 해서….</p>
</blockquote>

<p>그밖에는 아래 링크를 참조하자.</p>

<p><a href="http://codingmiles.com/mongodb-sharded-cluster-deployment/">9대링크 : http://codingmiles.com/mongodb-sharded-cluster-deployment/</a></p>

<p><a href="http://haru.kafra.kr/33">참조한 Post : http://haru.kafra.kr/33</a></p>

<p>물리서버 3대에 각 용도별 3대의 데몬을 띄울 것이다.</p>

<blockquote>
  <p>왜 굳이 3대일까? 공식사이트에선 1~3대의 configsvr를 구성하라고해서<br />
1개의 configsvr를 구성하려고 이것저것 세팅해봤는데 3대를 권장하는 워닝이 찜찜했다.. 결론은 3대 권장</p>
</blockquote>

<p><strong>필요한 서버</strong></p>

<ul>
  <li>CentOS 7 Linux Server X 3</li>
  <li>config server X 3</li>
  <li>shard server X 3</li>
  <li>router server X 3</li>
</ul>

<p>다양한 구성방법이 있지만 현재 필요한 용도로는 각 서버당 3개의 서버데몬이 다 올라가 있어야한다</p>

<p>보통 라우터는 한대만 놓지만 상위단에서 부하를 분할해야할 수도 있기 때문이다</p>

<p>간단한 개념은 사용자는 Router에 접속하여 config에서 정보를 얻고 shard에서 데이터를 r/w한다고 생각하면 된다</p>

<h2 id="사용">사용</h2>

<h3 id="server">Server</h3>

<h4 id="1-host-확인">1. host 확인</h4>

<p><img src="/images/mongo_sharding/1.png" alt="alt server" /></p>

<p>host 이름이 중요한데 각각 이렇게 정의했다</p>

<ul>
  <li>dbc : db center</li>
  <li>dbs1 : db shard #1</li>
  <li>dbs2 : db shard #2</li>
</ul>

<p>KT Cloud에서는 서버 생성시 호스트명을 선택할 수 있으며, 일반적인 경우에는 host파일을 수정하여 작업하면된다.</p>

<blockquote>
  <p>cloud server를 이용하면 마음껏 초기화, 제거 생성이 되서 테스트하기 편하다. 시간당 백원정도의 사용료가 들지만…<br />
이 테스트를 진행하며 시행착오로 서버를 한 50번은 재생성한 것 같다<br />
현재도 다 만들어 놓은거 3대 초기화하고 다시 정리하며 구성중 :(</p>
</blockquote>

<p>세팅 후 1대가 수평확장이 되는지 테스트하기 위해 우선 2대만 세팅을 해보기로한다</p>

<p>dbc, dbs1에 ssh로 root로 접속후</p>

<p>각각의 서버에서 서로간에 핑을 날려서 호스트명이 잘 작동하는지 확인한다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>ping dhc
ping dbs1
</code></pre>
</div>

<blockquote>
  <p>귀찮게 호스트 네이밍 정해야하는 이유는.. 3.4부터 아이피로 세팅 자체가 안되게 변경된 것 같다. 사이트에가서 확인해보면 된다.</p>
</blockquote>

<h4 id="2-update">2. Update</h4>

<p>각 서버에 인스톨 패키지를 최신화 시키자(선택사항임)</p>

<p><img src="/images/mongo_sharding/2.png" alt="alt yum" /></p>

<h4 id="3-저장공간-확보">3. 저장공간 확보</h4>

<p>KT Cloud의 경우 CentOS7으로 설치할 경우</p>

<p>20기가의 linux partition과 80기가의 빈 파티션이 주어진다.</p>

<p>당연히 데이터는 80기가의 파티션에 넣어야되기 때문에 포맷을 해야한다.</p>

<p><a href="https://docs.mongodb.com/manual/administration/production-notes/">https://docs.mongodb.com/manual/administration/production-notes/</a></p>

<blockquote>
  <p>읽어보면 ext4, xfs 둘다 되지만 xfs format을 권장한다 하지만 KT Cloud여건상 ext4로 할 수 밖에 없었다..</p>
</blockquote>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>mkdir /data //최상위에 마운트할 디렉토리 생성
fdisk -l //장치 목록 확인
fdisk /dev/xvdb //파티셔닝 n,p,엔터,엔터
mkfs.ext4 /dev/xvdb //포맷
ls -l /dev/disk/by-uuid //uuid확인 복사
vi /etc/fstab //시작시 자동마운트를 위해 편집기 실행
UUID=아까복사한아이디 /data ext4 defaults 1 2 //한 행 추가 저장
reboot //시작시 잘 마운트 되는지 확인
</code></pre>
</div>

<blockquote>
  <p>난 리눅스 전문가가 아니다 OS는 공부해야할 무언가가 아닌 편하게 쓰기 위한 시스템일 뿐이다.<br />
개발자의 경우 비즈니스 로직이 잘 돌아가는 플랫폼이면 그만이다.<br />
더 좋은 방법이 있으면 그것을 쓰면 된다.</p>
</blockquote>

<h4 id="4-db-install">4. DB install</h4>

<p>각 서버에 아래 링크의 내용대로 mongo를 설치한다.</p>

<p><a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/</a></p>

<blockquote>
  <p>이런건 항상 공식사이트의 레러런스대로 하는게 좋다.. 괜히 한글 사이트 찾아서 쉽게 해보려다가 더 나락으로 떨어질 수 있다.</p>
</blockquote>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>vi /etc/yum.repos.d/mongodb-org-3.4.repo //repo에 아래 내용 추가
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="pi">[</span><span class="nv">mongodb-org-3.4</span><span class="pi">]</span>
<span class="s">name=MongoDB Repository</span>
<span class="s">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/</span>
<span class="s">gpgcheck=1</span>
<span class="s">enabled=1</span>
<span class="s">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc</span>
</code></pre>
</div>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>yum install -y mongodb-org //설치
</code></pre>
</div>

<p>약 30초면 설치가 완료된다.</p>

<p>공식사이트대로 설치하고 나니 3.4.2가 깔린 것을 확인 할 수 있다</p>

<p><img src="/images/mongo_sharding/3.png" alt="alt mongoserver" /></p>

<blockquote>
  <p>yum update에서 예외케이스를 넣어줘야 3.5로 실수 업데이트 되는 멘붕을 막을 수 있어서 관리적으로 좋지만..<br />
보안 이슈도 있을 수 있으니 적응하는 편이 내 경우는 늘 좋았다.</p>
</blockquote>

<h4 id="5-mongo-server-정상화">5. mongo server 정상화</h4>

<p>일반적으로 설치 후 # mongo를 치면 그냥 프롬프트(&gt;) 가 뜨지만.. KT cloud에서는 워닝이 뜬다</p>

<p><img src="/images/mongo_sharding/4.png" alt="alt mongoserver" /></p>

<blockquote>
  <p>xfs는 내 잘못이 맞지만..</p>
</blockquote>

<p>Transparent Huge Pages Warning을 아래의 링크대로 하면 소거할 수 있다.</p>

<p><a href="https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/">https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/</a></p>

<blockquote>
  <p>결론은 끄라는 얘기다</p>
</blockquote>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>vi /etc/init.d/disable-transparent-hugepages //만들고 아래 내용을 붙혀넣는다
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1">#!/bin/bash</span>
<span class="c1">### BEGIN INIT INFO</span>
<span class="c1"># Provides:          disable-transparent-hugepages</span>
<span class="c1"># Required-Start:    $local_fs</span>
<span class="c1"># Required-Stop:</span>
<span class="c1"># X-Start-Before:    mongod mongodb-mms-automation-agent</span>
<span class="c1"># Default-Start:     2 3 4 5</span>
<span class="c1"># Default-Stop:      0 1 6</span>
<span class="c1"># Short-Description: Disable Linux transparent huge pages</span>
<span class="c1"># Description:       Disable Linux transparent huge pages, to improve</span>
<span class="c1">#                    database performance.</span>
<span class="c1">### END INIT INFO</span>

<span class="s">case $1 in</span>
  <span class="s">start)</span>
    <span class="s">if [ -d /sys/kernel/mm/transparent_hugepage ]; then</span>
      <span class="s">thp_path=/sys/kernel/mm/transparent_hugepage</span>
    <span class="s">elif [ -d /sys/kernel/mm/redhat_transparent_hugepage ]; then</span>
      <span class="s">thp_path=/sys/kernel/mm/redhat_transparent_hugepage</span>
    <span class="s">else</span>
      <span class="s">return 0</span>
    <span class="s">fi</span>

    <span class="s">echo 'never' &gt; ${thp_path}/enabled</span>
    <span class="s">echo 'never' &gt; ${thp_path}/defrag</span>

    <span class="s">re='^[0-1]+$'</span>
    <span class="s">if [[ $(cat ${thp_path}/khugepaged/defrag) =~ $re ]]</span>
    <span class="s">then</span>
      <span class="s"># RHEL 7</span>
      <span class="s">echo 0  &gt; ${thp_path}/khugepaged/defrag</span>
    <span class="s">else</span>
      <span class="s"># RHEL 6</span>
      <span class="s">echo 'no' &gt; ${thp_path}/khugepaged/defrag</span>
    <span class="s">fi</span>

    <span class="s">unset re</span>
    <span class="s">unset thp_path</span>
    <span class="s">;;</span>
<span class="s">esac</span>
</code></pre>
</div>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>chmod 755 /etc/init.d/disable-transparent-hugepages //파일에 모든 권한을 준다
chkconfig --add disable-transparent-hugepages //시작프로세스 등록
reboot
mongo //warning 없어졌는지 확인
</code></pre>
</div>

<h4 id="6-firewall">6. Firewall</h4>

<p>위에 설정한 dbc와 dbs1은 핑은 잘 날라가지만 서로간에 디비 연결이 안됨을 확인 할수 있다..</p>

<p>아래 명령어는 같다. 생략 되어있을 뿐</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="pi">[</span><span class="nv">root@dbc~</span><span class="pi">]</span> <span class="c1"># mongo</span>
<span class="pi">[</span><span class="nv">root@dbc~</span><span class="pi">]</span> <span class="c1"># mongo localhost</span>
<span class="pi">[</span><span class="nv">root@dbc~</span><span class="pi">]</span> <span class="c1"># mongo localhost:27017</span>
<span class="pi">[</span><span class="nv">root@dbc~</span><span class="pi">]</span> <span class="c1"># mongo dbc</span>
</code></pre>
</div>

<p>두대의 몽고가 서로 접속이 되어야 하는데 아래와 같이 서로에게 접속해본다.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="pi">[</span><span class="nv">root@dbc~</span><span class="pi">]</span> <span class="c1"># mongo dbs1</span>
<span class="pi">[</span><span class="nv">root@dbs1~</span><span class="pi">]</span> <span class="c1"># mongo dbc</span>
</code></pre>
</div>

<p>안되는 이유는 크게 두가지 이유가 있다.</p>

<ol>
  <li>/etc/mongod.conf 에 자신만 접속하게 되어있다.<br />
  bindIp : 127.0.0.1을 0.0.0.0으로 변경하면 누구든 다들어온다.</li>
  <li>방화벽<br />
  일반 데스크탑버전 리눅스와는 달리 서버리눅스는 대부분 방화벽이 기본적으로 켜져있다.</li>
</ol>

<blockquote>
  <p>KT Cloud에서 고맙게도 firewall-cmd을 enable 시켜놨고 ssh 빼고 다 막혀 있기 때문이다..<br />
다 막혀있는 룰 덕분에 쓸 포트만 추가하고 리로드 하면된다.</p>
</blockquote>

<p>MongoDB에서 기본값으로 잡아 놓은 포트는 아래와 같다</p>

<ul>
  <li>router : 27017</li>
  <li>shard : 27018</li>
  <li>config : 27019</li>
  <li>webstatus : 28017</li>
</ul>

<p>더 자세한건 아래 링크 참고</p>

<p><a href="https://docs.mongodb.com/manual/reference/default-mongodb-port/">https://docs.mongodb.com/manual/reference/default-mongodb-port/</a></p>

<blockquote>
  <p>기본값, 즉 디폴트인 것일 뿐 권장사항이 아니다.. public port는 절대적으로 변경해야한다. 
개발을 위해 또 다 막을 수는 없기 때문에 아이피 대역등으로 마스킹해야한다.(eg:x.x.x.0/24)
깔고나면 기본적으로 보안도 없어서 27017로 봇들이 들어와서 다 지우고 돈 요구한다..<br />
초반에 누가 접속하겠어? 하는 안일한 생각으로 운영할때 다 털린 경험이 있다…<br />
좋은 경험 덕분에 첫째도 보안, 둘째도 보안, N째도 보안 각성..<br />
[슬픈 추억 스크린샷]  <br />
<img src="/images/mongo_sharding/5.png" alt="alt mongoserver" /></p>
</blockquote>

<p><strong>규칙 추가</strong></p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>[root@dbc~] # firewall-cmd --permanent --zone=public --add-port=27017/tcp
[root@dbc~] # firewall-cmd --permanent --zone=public --add-port=27018/tcp
[root@dbc~] # firewall-cmd --permanent --zone=public --add-port=27019/tcp
[root@dbc~] # firewall-cmd --reload
[root@dbc~] # firewall-cmd --list-all
</code></pre>
</div>

<h4 id="7-mongo-server-shutdown">7. Mongo server shutdown</h4>

<p>위에 언급한대로 데몬을 새로 띄울 것이기 때문에 자동시작되는 기본서버를 꺼줘야한다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>systemctl disable mongod
reboot
</code></pre>
</div>

<blockquote>
  <p>9대의 서버라면 daemon이 아닌 각각의 /etc/mongo.conf 이것만 변경해서 systemctl restart mongod 하면 되지만…<br />
한대의 서버에 3개의 mongo server를 구동해야되기 때문에 각 용도별 다른 포트로 실행시켜야한다.</p>
</blockquote>

<h4 id="8-directory-make">8. Directory make</h4>

<p>mongo계정을 만들어서 각 저장소를 준비한다.</p>

<blockquote>
  <p>root계정으로 mongo를 실행하면 되긴되는데 워닝이 뜬다.  <br />
mongo계정으로 모든 관련 기능을 수행하길 권장하는 문구가 뜬다.<br />
그래서 mongo관련 데이터들을 mongo계정으로 만들어본다.</p>
</blockquote>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>useradd mongo
passwd mongo //입력
mkdir /data/mongo
chown -R mongo. /data/mongo //mongo의 권한으로 하위항목을 모두 위임
ls -al /data //mongo 권한 확인
su - mongo //mongo로 접속
mkdir /data/mongo/db
mkdir /data/mongo/arbiter
mkdir /data/mongo/configsvr
mkdir /data/mongo/shardsvr
mkdir /data/mongo/log
mkdir /data/mongo/pid
</code></pre>
</div>

<h4 id="9-shard-setting">9. Shard setting</h4>

<p>기본적으로 들어 있는 conf file은 아래와 같이 작성되어있다.</p>

<blockquote>
  <p><a href="https://ko.wikipedia.org/wiki/YAML">https://ko.wikipedia.org/wiki/YAML</a> 이라고 하는 데 마크다운과 비슷해 보인다.</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># mongod.conf</span>

<span class="c1"># for documentation of all options, see:</span>
<span class="c1">#   http://docs.mongodb.org/manual/reference/configuration-options/</span>

<span class="c1"># where to write logging data.</span>
<span class="s">systemLog</span><span class="pi">:</span>
  <span class="s">destination</span><span class="pi">:</span> <span class="s">file</span>
  <span class="s">logAppend</span><span class="pi">:</span> <span class="s">true</span>
  <span class="s">path</span><span class="pi">:</span> <span class="s">/var/log/mongodb/mongod.log</span>

<span class="c1"># Where and how to store data.</span>
<span class="s">storage</span><span class="pi">:</span>
  <span class="s">dbPath</span><span class="pi">:</span> <span class="s">/var/lib/mongo</span>
  <span class="s">journal</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">true</span>
<span class="c1">#  engine:</span>
<span class="c1">#  mmapv1:</span>
<span class="c1">#  wiredTiger:</span>

<span class="c1"># how the process runs</span>
<span class="s">processManagement</span><span class="pi">:</span>
  <span class="s">fork</span><span class="pi">:</span> <span class="s">true</span>  <span class="c1"># fork and run in background</span>
  <span class="s">pidFilePath</span><span class="pi">:</span> <span class="s">/var/run/mongodb/mongod.pid</span>  <span class="c1"># location of pidfile</span>

<span class="c1"># network interfaces</span>
<span class="s">net</span><span class="pi">:</span>
  <span class="s">port</span><span class="pi">:</span> <span class="s">27017</span>
  <span class="s">bindIp</span><span class="pi">:</span> <span class="s">127.0.0.1</span>  <span class="c1"># Listen to local interface only, comment to listen on all interfaces.</span>


<span class="c1">#security:</span>

<span class="c1">#operationProfiling:</span>

<span class="c1">#replication:</span>

<span class="c1">#sharding:</span>

<span class="c1">## Enterprise-Only Options</span>

<span class="c1">#auditLog:</span>

<span class="c1">#snmp:</span>
</code></pre>
</div>

<p>이중에 #은 주석으로 안 쓰는 것이니 실제 쓰는 것 위주로 파일을 재생성 한다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>vi /data/mongo/shardsvr.conf
</code></pre>
</div>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1"># shardsvr.conf</span>

<span class="s">systemLog</span><span class="pi">:</span>
  <span class="s">destination</span><span class="pi">:</span> <span class="s">file</span>
  <span class="s">logAppend</span><span class="pi">:</span> <span class="s">true</span>
  <span class="s">path</span><span class="pi">:</span> <span class="s">/data/mongo/log/shardsvr.log</span>

<span class="s">storage</span><span class="pi">:</span>
  <span class="s">dbPath</span><span class="pi">:</span> <span class="s">/data/mongo/shardsvr</span>
  <span class="s">journal</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">true</span>

<span class="s">processManagement</span><span class="pi">:</span>
  <span class="s">fork</span><span class="pi">:</span> <span class="s">true</span>  <span class="c1"># fork and run in background</span>
  <span class="s">pidFilePath</span><span class="pi">:</span> <span class="s">/data/mongo/pid/shardsvr.pid</span>  <span class="c1"># location of pidfile</span>

<span class="s">net</span><span class="pi">:</span>
  <span class="s">port</span><span class="pi">:</span> <span class="s">27018</span>
<span class="c1">#  bindIp: 127.0.0.1  # Listen to local interface only, comment to listen on all interfaces.</span>
  
<span class="s">replication</span><span class="pi">:</span>
  <span class="s">replSetName</span><span class="pi">:</span> <span class="s">rs0</span>

</code></pre>
</div>

<p>conf를 정리해보면</p>

<ul>
  <li>로그저장소 관련</li>
  <li>데이터저장소 관련</li>
  <li>백그라운드 실행 관련</li>
  <li>네트워크 관련</li>
  <li><a href="https://docs.mongodb.com/manual/replication/">복제 세트:https://docs.mongodb.com/manual/replication/</a> 구성(중요)</li>
</ul>

<blockquote>
  <p>복제 세트는 기존에는 구성하지 않아도 되었지만 3.4부터는 필수로 넣어줘야함</p>
</blockquote>

<p>각서버에 동일한 설정파일을 만들어서 아래와 같이 실행</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>mongod --shardsvr -f /data/mongo/shardsvr.conf //daemon이 위의 설정파일로 실행되었다.
ps -ef|grep mongo //프로세스를 확인해보면 포크된 번호와 일치한다.
</code></pre>
</div>

<p>샤드는 현재 상태에선 그냥 기본 서버와 크게 다르지 않다.</p>

<p>이제부터 복제세트, 즉 replica setting 을 해서 두 서버를 이어준다.</p>

<p>rs(replica setting)는 아래와 같은 method 있으니 참조하면 된다.</p>

<p><a href="https://docs.mongodb.com/manual/reference/method/js-replication/">https://docs.mongodb.com/manual/reference/method/js-replication/</a></p>

<p>둘중에 한군데서만 해야하는데 dbc서버에서 설정해보겠다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>mongo localhost:27018
&gt; rs.initiate()
{
 	"info2" : "no configuration specified. Using a default configuration for the set",
 	"me" : "dbc.localdomain:27018",
 	"ok" : 1
}
rs0:SECONDARY&gt; //이런 모양이됨
rs0:SECONDARY&gt; rs.status()
{
	"set" : "rs0",
	"date" : ISODate("2017-02-22T07:29:36.537Z"),
	"myState" : 1,
	"term" : NumberLong(1),
	"heartbeatIntervalMillis" : NumberLong(2000),
	"optimes" : {
		"lastCommittedOpTime" : {
			"ts" : Timestamp(1487748571, 1),
			"t" : NumberLong(1)
		},
		"appliedOpTime" : {
			"ts" : Timestamp(1487748571, 1),
			"t" : NumberLong(1)
		},
		"durableOpTime" : {
			"ts" : Timestamp(1487748571, 1),
			"t" : NumberLong(1)
		}
	},
	"members" : [
		{
			"_id" : 0,
			"name" : "dbc.localdomain:27018",
			"health" : 1,
			"state" : 1,
			"stateStr" : "PRIMARY",
			"uptime" : 27,
			"optime" : {
				"ts" : Timestamp(1487748571, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2017-02-22T07:29:31Z"),
			"infoMessage" : "could not find member to sync from",
			"electionTime" : Timestamp(1487748570, 2),
			"electionDate" : ISODate("2017-02-22T07:29:30Z"),
			"configVersion" : 1,
			"self" : true
		}
	],
	"ok" : 1
}
rs0:PRIMARY&gt; 
</code></pre>
</div>

<p>멤버가 하나 뿐인 복제셋이 완성되었다.</p>

<p>혼자이기 때문에 프라이머리이며 기본 서버처럼 읽고 쓰면 된다.</p>

<p>이제 멤버를 추가해보겠다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>rs0:PRIMARY&gt; rs.add("dbs1:27018")
{ "ok" : 1 }
rs0:PRIMARY&gt; rs.status()
{
	"set" : "rs0",
	"date" : ISODate("2017-02-22T07:37:14.876Z"),
	"myState" : 1,
	"term" : NumberLong(1),
	"heartbeatIntervalMillis" : NumberLong(2000),
	"optimes" : {
		"lastCommittedOpTime" : {
			"ts" : Timestamp(1487749021, 1),
			"t" : NumberLong(1)
		},
		"appliedOpTime" : {
			"ts" : Timestamp(1487749026, 1),
			"t" : NumberLong(1)
		},
		"durableOpTime" : {
			"ts" : Timestamp(1487749026, 1),
			"t" : NumberLong(1)
		}
	},
	"members" : [
		{
			"_id" : 0,
			"name" : "dbc.localdomain:27018",
			"health" : 1,
			"state" : 1,
			"stateStr" : "PRIMARY",
			"uptime" : 485,
			"optime" : {
				"ts" : Timestamp(1487749026, 1),
				"t" : NumberLong(1)
			},
			"optimeDate" : ISODate("2017-02-22T07:37:06Z"),
			"electionTime" : Timestamp(1487748570, 2),
			"electionDate" : ISODate("2017-02-22T07:29:30Z"),
			"configVersion" : 2,
			"self" : true
		},
		{
			"_id" : 1,
			"name" : "dbs1:27018",
			"health" : 1,
			"state" : 0,
			"stateStr" : "STARTUP",
			"uptime" : 8,
			"optime" : {
				"ts" : Timestamp(0, 0),
				"t" : NumberLong(-1)
			},
			"optimeDurable" : {
				"ts" : Timestamp(0, 0),
				"t" : NumberLong(-1)
			},
			"optimeDate" : ISODate("1970-01-01T00:00:00Z"),
			"optimeDurableDate" : ISODate("1970-01-01T00:00:00Z"),
			"lastHeartbeat" : ISODate("2017-02-22T07:37:14.753Z"),
			"lastHeartbeatRecv" : ISODate("1970-01-01T00:00:00Z"),
			"pingMs" : NumberLong(0),
			"configVersion" : -2
		}
	],
	"ok" : 1
}
rs0:PRIMARY&gt; 
</code></pre>
</div>

<p>멤버가 추가된 것을 확인 할수 있는데 stateStr을 보면 dbc는 primary인데 dbs1은 startup이다..</p>

<blockquote>
  <p>primary, secondary 둘 이외는 정상이 아니라고 보면된다.</p>
</blockquote>

<p><strong>dbs1입장에서 “name” : “dbc.localdomain:27018” 로 연결을 못하기 때문이다.</strong></p>

<p>dbs1입장에서는 “name” : “dbc:27018” 이 되어야 되기 때문이다…</p>

<p>최초 rs.initiate()에서 자동으로 들어간 “name” : “dbc.localdomain:27018” 때문에 접속이 안되는 것이다..</p>

<blockquote>
  <p>지나고보면 당연할 수도 있지만, 처음에 이것 때문에 정말 힘들었다…</p>
</blockquote>

<p>그래서 rs.initiate([{},{}]) 이런식으로 멤버를 넣어서 초기화하는것을 추천한다</p>

<p>이상황에서 그럼 dbc만 바꿔보자.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>rs0:SECONDARY&gt; cfg = rs.conf()
rs0:SECONDARY&gt; cfg.members[0].host = "dbc:27018"
rs0:SECONDARY&gt; rs.reconfig(cfg,{force:true})
rs0:SECONDARY&gt; rs.status()
{
	"set" : "rs0",
	"date" : ISODate("2017-02-22T07:43:42.138Z"),
	"myState" : 2,
	"term" : NumberLong(2),
	"syncingTo" : "dbs1:27018",
	"heartbeatIntervalMillis" : NumberLong(2000),
	"optimes" : {
		"lastCommittedOpTime" : {
			"ts" : Timestamp(1487749419, 1),
			"t" : NumberLong(2)
		},
		"appliedOpTime" : {
			"ts" : Timestamp(1487749419, 1),
			"t" : NumberLong(2)
		},
		"durableOpTime" : {
			"ts" : Timestamp(1487749419, 1),
			"t" : NumberLong(2)
		}
	},
	"members" : [
		{
			"_id" : 0,
			"name" : "dbc:27018",
			"health" : 1,
			"state" : 2,
			"stateStr" : "SECONDARY",
			"uptime" : 873,
			"optime" : {
				"ts" : Timestamp(1487749419, 1),
				"t" : NumberLong(2)
			},
			"optimeDate" : ISODate("2017-02-22T07:43:39Z"),
			"syncingTo" : "dbs1:27018",
			"configVersion" : 72000,
			"self" : true
		},
		{
			"_id" : 1,
			"name" : "dbs1:27018",
			"health" : 1,
			"state" : 1,
			"stateStr" : "PRIMARY",
			"uptime" : 385,
			"optime" : {
				"ts" : Timestamp(1487749419, 1),
				"t" : NumberLong(2)
			},
			"optimeDurable" : {
				"ts" : Timestamp(1487749419, 1),
				"t" : NumberLong(2)
			},
			"optimeDate" : ISODate("2017-02-22T07:43:39Z"),
			"optimeDurableDate" : ISODate("2017-02-22T07:43:39Z"),
			"lastHeartbeat" : ISODate("2017-02-22T07:43:40.486Z"),
			"lastHeartbeatRecv" : ISODate("2017-02-22T07:43:40.667Z"),
			"pingMs" : NumberLong(0),
			"electionTime" : Timestamp(1487749408, 1),
			"electionDate" : ISODate("2017-02-22T07:43:28Z"),
			"configVersion" : 72000
		}
	],
	"ok" : 1
}
rs0:SECONDARY&gt; 

</code></pre>
</div>

<p>이제 멤버들은 데이터를 복제해서 가지고 있다.</p>

<p>보면 dbc: secondary,dbs1: primary가 되어있다.</p>

<blockquote>
  <p>primary : read/write 가능<br />
secondary : read만 선택적으로 가능(rs.slaveOk() 입력할 경우)<br />
디비 작업을 하려면 프라이머리로 접속해야 하는 것이다.</p>
</blockquote>

<p>그러면 primary, secondary는 누가 결정하나…</p>

<p>대략 공식사이트 내용을 보면 네트워크 상황, 핑등을 고려하여 vote(투표)로 결정한다고 되어있다.</p>

<p>rs.conf()로 내용을 확인해보면 priority라는 것이 기본값인 1로 설정되어있다.</p>

<p>이것을 높게 주면 우선권이 높아지지만 같은 사양 물리 서버에서는 권장하고 있지는 않는다</p>

<p>이제 dbc를 primary로 바꾸고 싶은데 어떻게 해야할까?</p>

<p>method로는 없다. dbs1을 reboot 시키면 dbc가 primary가 된다. 뭔가 방법은 있겠지만 공식사이트에서는 권장하지 않는다.</p>

<p>[primary change]</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>[mongo@dbs1 mongo]$ ps -ef|grep mongo
root      4198  2512  0 16:09 pts/0    00:00:00 su - mongo
mongo     4199  4198  0 16:09 pts/0    00:00:00 -bash
mongo     4610     1  0 16:19 ?        00:00:00 mongod --shardsvr -f /data/mongo/shardsvr.conf
mongo     4759  4199  0 16:22 pts/0    00:00:00 ps -ef
mongo     4760  4199  0 16:22 pts/0    00:00:00 grep --color=auto mongo
[mongo@dbs1 mongo]$ kill 4610
mongod --shardsvr -f /data/mongo/shardsvr.conf //재구동

rs0:SECONDARY&gt; rs.status() //dbc에서 다시 확인

</code></pre>
</div>

<p>dbc에서 rs.status()를 계속 쳐보면 dbs1의 상태가 변하는 것이 확인된다.</p>

<p>둘다 secondary가 되었다가 몇분후 dbc가 다시 primary를 가져간다..</p>

<p>이제 데이터를 써보고 두대를 교대로 껏다켰다하면서 <strong>primary로 설정되어있는 db</strong> 에 연결해서 데이터가 온전한지 확인해 보면 된다.</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>rs0:PRIMARY&gt; use test
switched to db test
rs0:PRIMARY&gt; for(var i = 0; i &lt; 100000; i++) db.trash.insert({n:i,d:"tt"})
</code></pre>
</div>

<p>실수로 root로 실행 하게 되면 root로 파일권한을 바꿔버리기 때문에 mongo계정으로는 실행이 안되는 현상이있다.</p>

<p>ERROR: child process failed, exited with error number 100</p>

<p>데이터 확인해보고 아래와 같이 해결하면 된다..</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>chown -R mongo. /data/mongo/shardsvr
</code></pre>
</div>

<blockquote>
  <p>crontab -e 로 자동화하려다 mongod가 fork 되지 않는다는 메세지가 뜨면서 영원히 실행이 안되서 당황한 적이 있다.</p>
</blockquote>

<h2 id="결론">결론</h2>

<p>여기까지 작업만해도 수평확장은 되는 셈이다.</p>

<p>하지만 primary가 누군지 알수 없기 때문에 configsvr, router를 통하지 않으면 백업용도 외에는 쓰기가 어렵다…</p>

<p>성능은 좋으나 설치가 까다롭고 자료가 너무 없다.</p>

<blockquote>
  <p>공식사이트에서 영문 매뉴얼 파야한다.<br />
apm(apache php mysql) installer, wizard 같은 툴이 있으면 좋겠음..<br />
node.js &amp; npm 조합이 그리움…</p>
</blockquote>

<p>점수 7점</p>

<h2 id="의견">의견</h2>

<p>여기에는 기본포트를 쓰고 있지만 실제 서비스에서는 절대 기본포트를 쓰면 안된다.</p>

<p>물론 포트 변경가지고는 절대방어가 되지 않지만, 봇이 더 많은 포트 탐색을 하게 만드는 역활정도는 해준다.</p>

<p>실제로는 어플리케이션 서버(node.js + mongoose api)에서만 접속하게 방화벽 세팅을 해야한다.</p>

<p>공인 포트로는 들어갈 일이 없게 만들어야한다.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#database" class="page__taxonomy-item" rel="tag">database</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#mongo" class="page__taxonomy-item" rel="tag">mongo</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#mongodb" class="page__taxonomy-item" rel="tag">mongoDB</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2017-02-22T00:00:00+09:00">February 22, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?via=fkkmemi&text=Mongo Sharding 1 - shard 구성 http://localhost:4000/mongodb/mongo-sharding-1/" class="btn btn--twitter" title="공유하기 Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/mongodb/mongo-sharding-1/" class="btn btn--facebook" title="공유하기 Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http://localhost:4000/mongodb/mongo-sharding-1/" class="btn btn--google-plus" title="공유하기 Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/mongodb/mongo-sharding-1/" class="btn btn--linkedin" title="공유하기 LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/github/markdown/" class="pagination--pager" title="Markdown
">이전</a>
    
    
      <a href="http://localhost:4000/mongodb/mongo-sharding-2/" class="pagination--pager" title="Mongo Sharding 2 - config,router 구성
">다음</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
    
        <h4 class="page__comments-title">댓글남기기</h4>
        <section id="disqus_thread"></section>
      
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    
    
      <li><a href="https://twitter.com/fkkmemi"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
      <li><a href="https://facebook.com/fkkmemi"><i class="fa fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
    
    
      <li><a href="http://github.com/https://github.com/fkkmemi"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 fkkmemi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-93372301-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




  
      
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'fkkmemi';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    



  </body>
</html>
